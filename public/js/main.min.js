let visibly_filter=1,files_public=1,task_in_progress=0,active_notification=0,notification_title='',document_title=$(document).attr('title');localStorage.getItem('active_notification')&&(active_notification=localStorage.getItem('active_notification'),notification_title=localStorage.getItem('notification_title')),$(window).load(function(){0<$('.message-block').length&&$('.message-block').scrollTop($('.message-item:last-child').position().top)}),$(document).ready(function(){if(!(0!=$('#notification-check').val()))active_notification=0,localStorage.setItem('active_notification',active_notification);else if(0<active_notification){$('.notification-bell').show().attr('title',notification_title);let f='';for(var a=0;a<active_notification;a++)f+='\u2022 ';$(document).attr('title',f+document_title)}console.log(active_notification);let b=$('#ip').val(),c=new ab.connect('ws://'+b+':8080',function(f){f.subscribe('onNewData',function(g,h){notification(h.data)})},function(f,g,h){console.warn('Websocket connection closed! Code = '+f+'; Reason = '+g+'; Detail = '+h+';')},{maxRetries:60,retryDelay:4000,skipSubprotocolCheck:!0});console.log(c);let d=$('body');autosize($('textarea')),$('#panel1').show(300),sortTasksItems(),titleToEmptyLinks(),$('#user-dialog-button').click(function(f){f.preventDefault(),$('.user-dialog').toggle(300)}),$('.files-toggler span').click(function(){$('.files-toggler span').toggleClass('active'),$('#public-files').toggle(300),$('#private-files').toggle(300),files_public=1==files_public?0:1,$('#file-is-public').val(files_public)}),d.mouseup(function(f){let g=$('.dialog');0===g.has(f.target).length&&g.hide()}),d.mouseup(function(f){let g=$('#image-modal');0===g.has(f.target).length&&g.hide()}),$('.tasks-add-tusk-button').click(function(){let f=$(this).attr('data-id');$('#form-'+f).toggle(300)}),$('.task-start-button').click(function(){let f=$(this).attr('data-id');changeTaskStatus(f,1)}),$('.task-resume-button').click(function(){let f=$(this).attr('data-id');changeTaskStatus(f,1)}),$('.task-pause-button').click(function(){let f=$(this).attr('data-id');changeTaskStatus(f,2)}),$('.task-finish-button').click(function(){let f=$(this).attr('data-id');changeTaskStatus(f,3)}),$('.task-delegate-button').click(function(){let f=$(this).attr('data-id'),g=$('#delegate_id-'+f).val();delegateTask(f,g)}),$('.close').click(function(){$('.sidebar').hide(300),$('.main').removeClass('col-md-9').addClass('col-md-12').css('margin-left','0px'),$('.menu-button').show()}),d.on('click','.menu-button',function(){$('.sidebar').show(300),$('.main').removeClass('col-md-12').addClass('col-md-9').css('margin-left','320px'),$('.menu-button').hide()}),$('.reports-header').click(function(){$('.reports-closed').toggle(),$('.reports-opened').toggle(),$('.reports-body').toggle()}),$('.filter').click(function(){$('.filter-dialog').toggle(300)}),$('.new-tasks-header').click(function(){$('.new-tasks-closed').toggle(),$('.new-tasks-opened').toggle(),$('.new-tasks-body').toggle()}),$('.today-tasks-header').click(function(){$('.today-tasks-closed').toggle(),$('.today-tasks-opened').toggle(),$('.today-tasks-body').toggle()}),$('.later-tasks-header').click(function(){$('.later-tasks-closed').toggle(),$('.later-tasks-opened').toggle(),$('.later-tasks-body').toggle()}),$('.upcoming-tasks-header').click(function(){$('.upcoming-tasks-closed').toggle(),$('.upcoming-tasks-opened').toggle(),$('.upcoming-tasks-body').toggle()}),$('.complete-button').click(function(){let f=$(this).attr('data-id');toggleStatusAjax(f)}),d.on('click','#incompletable-radio',function(){$('.task-visibly-status-0').show(),$('.task-visibly-status-1').show(),$('.task-visibly-status-2').show(),$('.task-visibly-status-3').hide(),$('.filter-dialog').hide(300),visibly_filter=1}),d.on('click','#completable-radio',function(){$('.task-visibly-status-0').hide(),$('.task-visibly-status-1').hide(),$('.task-visibly-status-2').hide(),$('.task-visibly-status-3').show(),$('.filter-dialog').hide(300),visibly_filter=2}),d.on('click','#all-radio',function(){$('.task-visibly-status-0').show(),$('.task-visibly-status-1').show(),$('.task-visibly-status-2').show(),$('.task-visibly-status-3').show(),$('.filter-dialog').hide(300),visibly_filter=3}),d.on('click','.time-mark-button',function(){let f=$(this).attr('data-id');$('#mark-dialog-'+f).toggle(300)}),d.on('click','.time-mark',function(){let f=$(this).attr('data-id'),g=$(this).attr('data-mark');changeTimeMarkAjax(f,g)}),$('.create-task-button').click(function(){$('#edit-task-title-input').val(''),$('#edit-task-text-input').val('');let f=$('#create-task-project-input').val(),g=$('#user-id').val();createEmptyTaskAjax(f,g)}),d.on('click','#close-create-task-panel',function(){$('.left-panel').addClass('col-md-12').removeClass('col-md-6'),$('.right-panel').hide()}),d.on('click','#close-edit-task-panel',function(){$('.left-panel').addClass('col-md-12').removeClass('col-md-6'),$('.right-panel-edit').hide()}),d.on('click','.add-task-to-project span',function(){$('.task-to-project-dialog').show(300)}),d.on('click','.edit-add-task-to-project span',function(){$('.edit-task-to-project-dialog').show(300)}),d.on('click','.add-task-to-project-dialog-project',function(){let f=$(this).attr('data-id'),g=$(this).text();$('#create-task-project-input').val(f),$('.task-to-project-dialog').hide(300),$('.add-task-to-project span').text(g)}),d.on('click','.edit-add-task-to-project-dialog-project',function(){let f=$(this).attr('data-id'),g=$(this).text();$('#edit-task-project-input').val(f),$('.edit-task-to-project-dialog').hide(300),$('.edit-add-task-to-project span').text(g)}),d.on('click','.save-user',function(){let f=$(this).attr('data-id'),g=$('#user-role-'+f).val();updateUserAjax(f,g)}),d.on('click','#create-project-status',function(){1===$(this).val()?($(this).removeClass('create-project-status').addClass('create-project-status-active'),$('#create-task-status-input').val(3)):($(this).addClass('create-project-status').removeClass('create-project-status-active'),$('#create-task-status-input').val(1))}),d.on('click','#edit-project-status',function(){1===$(this).val()?($(this).removeClass('edit-project-status').addClass('edit-project-status-active'),$('#edit-task-status-input').val(3)):($(this).addClass('edit-project-status').removeClass('edit-project-status-active'),$('#edit-task-status-input').val(1))}),d.on('click','#create-task-attach-button',function(){$('#task-attach-popup').toggle(300)}),d.on('click','#edit-task-attach-button',function(){$('#task-attach-popup').toggle(300)}),d.on('click','.upload-close',function(){$('#task-attach-popup').toggle(300)}),$('.page-header-submenu').click(function(){$('.page-header-submenu').toggleClass('page-header-submenu-active'),$('#my_tasks-list').toggle(300),$('#my_tasks-files').toggle(300),$('#inbox-active').toggle(300),$('#inbox-arhive').toggle(300)}),d.on('click','.task-link',function(f){f.preventDefault();let g=$(this).attr('data-id');getTaskAjax(g)}),d.on('click','#edit-task-delete-button',function(){if(confirm('\u0423\u0434\u0430\u043B\u0438\u0442\u044C?')){let f=$(this).attr('data-id');deleteTaskAjax(f)}}),d.on('click','.comment-delete-button',function(){if(confirm('\u0423\u0434\u0430\u043B\u0438\u0442\u044C?')){let f=$(this).attr('data-id');deleteCommentAjax(f)}}),d.on('click','#delete-project-submit',function(){if(confirm('\u0423\u0434\u0430\u043B\u0438\u0442\u044C?')){let f=$('#edit-project-id').val();deleteProjectAjax(f)}}),d.on('click','.restore-project',function(){let f=$(this).attr('data-id');restoreProjectAjax(f)}),d.on('click','.asignee-button',function(){let f=$(this).attr('data-id');$('#asignee-dialog-'+f).toggle(300)}),d.on('change','.asignee-select',function(){let f=$(this).attr('data-id'),g=$(this).val();asigneeAjax(f,g)}),$('.new-project-button').click(function(f){f.preventDefault(),$('#new-project-dialog').toggle(300)}),d.on('click','.new-project-close',function(){$('#new-project-dialog').hide(300)}),d.on('click','#new-project-create',function(){let f=' ';$('#new-project-text').val()&&(f=$('#new-project-text').val()),$('#new-project-title').val()?createProjectAjax($('#new-project-title').val(),f,$('#new-project-alias').val()):alert('\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043F\u0440\u043E\u0435\u043A\u0442\u0430!')}),d.on('click','.move-to-arhive',function(){let f=$(this).attr('data-id');toggleArhiveCommentAjax(f)}),$('#all-to-arhive').click(function(f){f.preventDefault();let g=[];$('.comments-active-body .comment-item').each(function(){g.push($(this).attr('data-id'))}),allToArhiveAjax(g)}),$('.restore-task-button').click(function(){let f=$(this).attr('data-id');restoreTaskAjax(f)}),d.on('click','.edit-project',function(){let f=$(this).attr('data-id');getProjectAjax(f)}),d.on('click','.close-edit-project',function(){$('.projects-panel').show(300),$('.edit-project-panel').hide(300)}),d.on('click','#edit-project-submit',function(){let f=$('#edit-project-id').val(),g=$('#edit-project-title').val(),h=$('#edit-project-text').val(),j=$('#edit-project-alias').val();updateProjectAjax(f,g,h,j)}),d.on('click','#edit-task-comment-submit',function(f){f.preventDefault(),sendCommentAjax()}),d.on('click','#edit-task-submit',function(f){f.preventDefault(),updateTaskAjax()}),d.on('click','#new-task-submit',function(f){f.preventDefault(),$('#title-new-task').val()?createTaskAjax():alert('\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0437\u0430\u0434\u0430\u0447\u0438!')}),d.on('change','#subscribe-radio',function(){toggleSubscribeAjax()}),d.on('click','.project-edit-button',function(){$('.edit-project-dialog').toggle(300)}),d.on('click','.edit-project-close',function(){$('.edit-project-dialog').toggle(300)}),d.on('click','.comment-edit-button',function(){let f=$(this).attr('data-id');$('#edit-comment-id').val(f),$('#edit-comment-text').val($('#comment-text-'+f).text()),$('.edit-comment-dialog').toggle(300)}),d.on('click','.edit-comment-close',function(){$('.edit-comment-dialog').toggle(300)}),d.on('click','#edit-project-save',function(){let f=$('#edit-project-id').val(),g=$('#edit-project-title').val(),h=$('#edit-project-text').val(),j=$('#edit-project-alias').val();updateProjectAjax(f,g,h,j)}),d.on('click','#edit-comment-save',function(){let f=$('#edit-comment-id').val(),g=$('#edit-comment-text').val();updateCommentAjax(f,g)}),d.on('click','.img-preview',function(){let f=$(this).attr('data-url');showImageModal(f)}),d.on('click','.img-small-preview',function(){let f=$(this).attr('data-url');showImageModal(f)}),d.on('click','.close-image-modal',function(){$('#image-modal').hide()}),d.on('click','.file-delete',function(){let f=$(this).attr('data-id');confirm('\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0444\u0430\u0439\u043B?')&&deleteFileAjax(f)}),d.on('click','#copy-url-button',function(){let f=$('#edit-task-id-input').val(),g=$('#current-user').val(),h=document.location.protocol+'//'+document.location.host+'/list/'+g+'/0/0/'+f;$('#task-url').text(h),copyToClipboard($('#task-url'))}),d.on('click','#text-preview',function(){$(this).hide(),$('#edit-task-text-input').show()}),d.on('focusout','#edit-task-text-input',function(){$(this).hide(),$('#text-preview').html(findLinks($(this).val())).show()}),d.on('click','.follow-button-block',function(){let f=$(this).attr('data-post_id'),g=$(this).attr('data-type'),h=$('#current-user').val();toggleFollowerAjax(f,h,g)}),d.on('click','.add-follower-button',function(){$('.followers-dialog').toggle(300)}),d.on('click','.followers-dialog ul li',function(){let f=$(this).attr('data-post_id'),g=$(this).attr('data-user_id'),h=$(this).attr('data-type');toggleFollowerAjax(f,g,h)}),d.on('click','.mention-button',function(){$('.mention-dialog').toggle(300)}),d.on('click','.mention-dialog ul li',function(){let f=$(this).attr('data-name'),g=$('#edit-task-text-input').val()+' @'+f;$('#edit-task-text-input').val(g),$('#text-preview').text(g),$('.mention-dialog').hide(300)}),d.on('click','#new-conversation-mention',function(){$('.new-conversation-mention-dialog').toggle(300)}),d.on('click','.message-mention-button',function(){let f=$(this).attr('data-conversation_id');$('#mention-dialog-'+f).toggle()}),d.on('click','.new-conversation-mention-dialog ul li',function(){let f=$(this).attr('data-name'),g=$('#new-conversation-message').val()+' @'+f;$('#new-conversation-message').val(g),$('.new-conversation-mention-dialog').hide(300)}),d.on('click','.mention-dialog ul li',function(){let f=$(this).attr('data-name'),g=$(this).attr('data-conversation_id'),h=$('#new-message-'+g).val()+' @'+f;$('#new-message-'+g).val(h),$('.mention-dialog').hide(300)}),$('#new-conversation-attach-input').change(function(){let f=new FormData;f.append('attachment',this.files[0]),uploadConversationAttachAjax(f)}),d.on('change','.message-attach-input',function(){let f=new FormData,g=$(this).attr('data-conversation_id');f.append('attachment',this.files[0]),uploadMessageAttachAjax(f,g)}),$('#new-conversation-submit').click(function(){let f=$('#current-user').val(),g=$('#new-conversation-attachment-id-input').val(),h=$('#new-conversation-title').val(),j=$('#new-conversation-message').val();j||g?createConversationAjax(h,f,j,g):alert('\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F \u0438\u043B\u0438 \u0434\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435')}),d.on('click','.message-submit',function(){let f=$(this).attr('data-conversation_id'),g=$('#message-attachment-id-input-'+f).val(),h=$('#new-message-'+f).val();h||g?sendMessageAjax(h,g,f):alert('\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F \u0438\u043B\u0438 \u0434\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435')})});function sendMessageAjax(a,b,c){$('.loading').show(),ajaxSetup(),$.ajax({url:'/sendMessageAjax/',dataType:'json',data:{message_text:a,attachment_id:b,conversation_id:c},success:function(){$('.loading').hide(),$('#new-message-'+c).val(''),$('#message-attachment-block-'+c).empty(),$('#message-attachment-id-input-'+c).val('')}})}function createConversationAjax(a,b,c,d){$('.loading').show(),ajaxSetup(),$.ajax({url:'/createConversationAjax/',dataType:'json',data:{conversation_title:a,user_id:b,message_text:c,attachment_id:d},success:function(f){$('.loading').hide(),$('#new-conversation-title').val(''),$('#new-conversation-message').val('');let g='';f.success.message.attachment_id&&(g='<div class="message-attachment">\n                      <img class="img-small-preview" src="/download/'+f.success.message.attacment_id+'"\n                        style="max-width: 50%; margin-top: 10px; margin-bottom: 10px;"\n                        data-url="/download/'+f.success.message.attacment_id+'">\n                    </div>\n');let h='';for(var j=0;j<f.success.users.length;j++)h=h+'<li data-name="'+f.success.users[j].name+'" data-conversation_id="'+f.success.conversation.id+'">'+f.success.users[j].name+'</li>';let k='';for(var j=0;j<f.success.users.length;j++)f.success.users[j].id!=$('#current-user').val&&(k=k+'<li data-user_id="'+f.success.users[j].id+'" data-post_id="'+f.success.conversation.id+'" data-type="conversation"    id="follower-list-item-'+f.success.users[j].id+'">'+f.success.users[j].name+'  <i class="fa fa-plus-square-o toggle-follower" aria-hidden="true"></i></li>');$('.conversations-block').prepend('<div class="panel panel-default conversations-item">\n  <div class="panel-heading">\n    <h3>\n      <a href="/conversations/'+f.success.conversation.id+'" class="'+f.success.conversation.title_class+'">\n'+f.success.conversation.title+'      </a>\n    </h3>\n  </div>\n  <div class="panel-body">\n    <div class="message-block" id="message-block-'+f.success.conversation.id+'">\n      <div class="message-item message-item-my">\n        <div class="message-heading">\n          <b>'+f.success.message.author+'</b>\n          <small>'+f.success.message.created_at+'</small>\n        </div>\n        <div class="message-body">\n'+f.success.message.text+'        </div>\n'+g+'      </div>\n    </div>\n    <input type="hidden" id="message-attachment-id-input-'+f.success.conversation.id+'" >\n    <input type="file" id="message-attach-input-'+f.success.conversation.id+'" accept="image/*" style="display: none"        class="message-attach-input" data-conversation_id="'+f.success.conversation.id+'">\n    <textarea id="new-message-'+f.success.conversation.id+'" rows="1" class="form-control" style="border: solid 1px #cccccc"></textarea>\n    <div id="message-attachment-block-'+f.success.conversation.id+'"></div>\n    <button class="btn btn-primary message-submit" id="message-submit-'+f.success.conversation.id+'"        data-conversation_id="'+f.success.conversation.id+'">\n      \u041E\u0442\u043F\u0440\u0430\u0432\u0438\u0442\u044C\n    </button>\n    <div class="float-right conversation-button" id="message-attach-'+f.success.conversation.id+'"         data-conversation_id="'+f.success.conversation.id+'">\n      <label for="message-attach-input-'+f.success.conversation.id+'"><i class="fa fa-paperclip" aria-hidden="true"></i></label>\n    </div>\n    <div class="float-right conversation-button message-mention-button" id="message-mention-button-'+f.success.conversation.id+'"\n         data-conversation_id="'+f.success.conversation.id+'">\n      <i class="fa fa-at" aria-hidden="true"></i>\n    </div>\n    <div class="dialog mention-dialog" id="mention-dialog-'+f.success.conversation.id+'">\n      <ul>\n'+h+'      </ul>\n    </div>    <hr/>\n    <div class="row">\n      <div class="col-md-8">\n        \u041F\u043E\u0434\u043F\u0438\u0441\u0447\u0438\u043A\u0438:\n        <span class="followers-list">\n        </span>\n        <span class="add-follower-button">\n            <i class="fa fa-user-plus" aria-hidden="true" title="\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u043F\u043E\u0434\u043F\u0438\u0441\u0447\u0438\u043A\u0430"></i>\n        </span>\n        <span class="dialog followers-dialog">\n          <ul>\n'+k+'          </ul>\n        </span>\n      </div>\n      <div class="col-md-4">\n        <span class="follow-button-block float-right"\n              data-post_id="'+f.success.conversation.id+'" data-type="conversation">\n          <i class="fa fa-bell-o" aria-hidden="true"></i>\n          <span class="follow-button-text">\n            \u041F\u043E\u0434\u043F\u0438\u0441\u0430\u0442\u044C\u0441\u044F\n          </span>\n        </span>\n      </div>\n    </div>  </div>\n</div>'),autosize($('textarea'))}})}function uploadMessageAttachAjax(a,b){$('.loading').show(),ajaxSetup(),$.ajax({url:'/uploadMessageAttachAjax/',type:'POST',data:a,processData:!1,contentType:!1,success:function(c){let d=JSON.parse(c);$('.loading').hide(),$('#message-attachment-id-input-'+b).val(d.success.id),$('#message-attachment-block-'+b).empty().append('<img class="img-small-preview" src="/download/'+d.success.id+'" style="max-width: 50%; margin-top: 10px;"data-url="/download/'+d.success.id+'">')}})}function uploadConversationAttachAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/uploadMessageAttachAjax/',type:'POST',data:a,processData:!1,contentType:!1,success:function(b){let c=JSON.parse(b);$('.loading').hide(),$('#new-conversation-attachment-id-input').val(c.success.id),$('#new-conversation-attachment-block').empty().append('<img class="img-small-preview" src="/download/'+c.success.id+'" style="max-width: 50%; margin-top: 10px;"data-url="/download/'+c.success.id+'">')}})}function toggleFollowerAjax(a,b,c){$('.loading').show(),ajaxSetup(),$.ajax({url:'/toggleFollowerAjax/',dataType:'json',data:{task_id:a,user_id:b,type:c},success:function(d){$('.loading').hide(),'followed'===d.success.followed?($('#current-user').val()===b&&($('.follow-button-block').addClass('follow-button-block-active'),$('.follow-button-text').text(' \u041E\u0442\u043F\u0438\u0441\u0430\u0442\u044C\u0441\u044F')),$('#follower-list-item-'+d.success.user.id+' .toggle-follower').removeClass('fa-plus-square-o').addClass('fa-minus-square-o'),$('.followers-list').append('<a href="/list/'+d.success.user.id+'/0/0" class="users-item" title="'+d.success.user.name+'"id="followers-item-'+d.success.user.id+'"\nstyle="background: '+d.success.user.color+'; margin-left: 0; margin-right: 0;">\n'+d.success.user.first_letters+'</a>')):($('#current-user').val()===b&&($('.follow-button-block').removeClass('follow-button-block-active'),$('.follow-button-text').text(' \u041F\u043E\u0434\u043F\u0438\u0441\u0430\u0442\u044C\u0441\u044F')),$('#follower-list-item-'+d.success.user.id+' .toggle-follower').addClass('fa-plus-square-o').removeClass('fa-minus-square-o'),$('#followers-item-'+d.success.user.id).detach())}})}function findLinks(a){let b=/((ftp|http|https):\/\/)?(www\.)?([A-Za-zА-Яа-я0-9]{1}[A-Za-zА-Яа-я0-9\-]*\.?)*\.{1}[A-Za-zА-Яа-я0-9-]{2,8}(\/([\w#!:.?+=&%@!\-\/])*)?/g;if(a)return a.replace(b,'<a href="$&" target="_blank" rel="nofollow">$&</a>')}function notification(a){if(5>active_notification&&('new_message'==a.message_flag&&a.follower_id==$('#current-user').val()||!a.message_flag)){active_notification++;let g='';for(var b=0;b<active_notification;b++)g+='\u2022 ';$(document).attr('title',g+document_title)}notification_title=a.text,localStorage.setItem('active_notification',active_notification),localStorage.setItem('notification_title',notification_title),$('.notification-bell').show().attr('title',notification_title);let c='',d='';a.project_name&&(c='<span class="project-title"><a href="/list/0/'+a.project_id+'/1" style="background-color: '+a.project_color+'">'+a.project_name+'</a></span>'),d=(a.type='comment')?'<a href="/list/'+a.author_id+'/0/0">'+a.author+': </a>':a.author+': ';let f='';if(a.alias&&(f=a.alias),'new_message'==a.message_flag&&a.follower_id==$('#current-user').val()){let g='';g=a.author_id==$('#current-user').val()?'message-item-my':'message-item-other';let h='';a.attachment&&(h='  <div class="message-attachment">\n    <img class="img-small-preview" src="/download/'+a.attachment.id+'"\n      style="max-width: 50%; margin-top: 10px; margin-bottom: 10px;"\n      data-url="/download/'+a.attachment.id+'">\n   </div>\n');let j='';a.text&&(j=a.text),$('#message-block-'+a.conversation_id).append('<div class="message-item '+g+'" id="message-item-'+a.id+'">\n  <div class="message-heading">\n    <b>'+a.author+'</b> <small>'+a.created_at+'</small>\n  </div>\n<div class="message-body">\n'+j+'</div>\n'+h+'</div>').scrollTop(999999999),$('.comments-active-body').prepend('<div class="comment-item row" data-id="'+a.comment_id+'" id="comment-item-'+a.comment_id+'">\n  <div class="col-md-11">    <div>      <span id="comment-conversation-item-'+a.conversation_id+'">        \u041E\u0431\u0441\u0443\u0436\u0434\u0435\u043D\u0438\u0435      </span>    </div>    <h3>      <a href="/conversations/'+a.conversation_id+'">'+a.conversation_title+'      </a>    </h3>    <p>\n      <b>Kodo CRM :</b>\n'+a.comment+'      <small>'+a.created_at+'</small>\n    </p>    <hr>\n  </div>\n  <div class="col-md-1 move-to-arhive" data-id="'+a.comment_id+'">\n    <i class="fa fa-times" id="move-to-arhive-'+a.comment_id+'" aria-hidden="true" title="\u041E\u0442\u043F\u0440\u0430\u0432\u0438\u0442\u044C \u0432 \u0430\u0440\u0445\u0438\u0432"></i>\n    <i class="fa fa-undo" id="move-to-active-'+a.comment_id+'" aria-hidden="true" title="\u0412\u0435\u0440\u043D\u0443\u0442\u044C"\n        style="display: none"></i>\n  </div>\n</div>')}else a.message_flag||$('.comments-active-body').prepend('<div class="comment-item row" data-id="'+a.id+'" id="comment-item-'+a.id+'">\n  <div class="col-md-11">\n    <div>\n      <span class="complete-button complete-status-'+a.task_status+'">\n        <i class="fa fa-check-circle-o" aria-hidden="true"></i>\n      </span>\n      <span id="comment-task-item-'+a.task_id+'">\u0417\u0430\u0434\u0430\u0447\u0430\n'+c+'      </span>\n    </div>\n    <h3>\n      <a href="/list/'+$('#current-user').val()+'/0/0/'+a.task_id+'" class="task-link"\n        data-id="'+a.task_id+'" id="task-link-'+a.task_id+'">\n        <b>'+f+' </b>\n'+a.task_name+'      </a>\n    </h3>\n    <p>\n      <b>\n'+d+'      </b>\n'+a.text+'      <small>'+a.created_at+'</small>\n    </p>\n    <hr>\n  </div>\n  <div class="col-md-1 move-to-arhive" data-id="'+a.id+'">\n    <i class="fa fa-times" id="move-to-arhive-'+a.id+'" aria-hidden="true" title="\u041E\u0442\u043F\u0440\u0430\u0432\u0438\u0442\u044C \u0432 \u0430\u0440\u0445\u0438\u0432"></i>\n    <i class="fa fa-undo" id="move-to-active-'+a.id+'" aria-hidden="true" title="\u0412\u0435\u0440\u043D\u0443\u0442\u044C"\n                                               style="display: none"></i>\n   </div>\n</div>')}function copyToClipboard(a){var b=$('<input>');$('body').append(b),b.val($(a).text()).select(),document.execCommand('copy'),b.remove()}function titleToEmptyLinks(){$('.task-link').each(function(){(''==$(this).text().trim()||null==$(this).text().trim())&&$(this).html('<span class="empty-title">\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F</span>')})}function showImageModal(a){$('#image-modal-image').attr('src',a),$('#image-modal').show()}function sortTasksItems(){$('.all-tasks-body .task-item').each(function(){$(this).hasClass('time-mark-new')?$('.new-tasks-body').append($(this).detach()):$(this).hasClass('time-mark-today')?$('.today-tasks-body').append($(this).detach()):$(this).hasClass('time-mark-later')?$('.later-tasks-body').append($(this).detach()):$(this).hasClass('time-mark-upcoming')&&$('.upcoming-tasks-body').append($(this).detach())}),$('.task-visibly-status-3').hide()}function deleteFileAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/deleteFileAjax/',dataType:'json',data:{file_id:a},success:function(b){$('.loading').hide(),$('#file-item-'+b.success.id).detach(),$('#small-file-item-'+b.success.id).detach()}})}function deleteCommentAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/deleteCommentAjax/',dataType:'json',data:{comment_id:a},success:function(b){$('.loading').hide(),$('#comment-item-'+b.success.id).detach()}})}function getProjectAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/getProjectAjax/',dataType:'json',data:{project_id:a},success:function(b){$('.loading').hide(),$('.projects-panel').hide(300),$('.edit-project-panel').show(300),$('#edit-project-title').val(b.success.title),$('#edit-project-text').val(b.success.text),$('#edit-project-id').val(b.success.id),$('#edit-project-alias').val(b.success.alias)}})}function getTaskAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/getTaskAjax/',dataType:'json',data:{task_id:a},success:function(b){$('.loading').hide(),$('#edit-task-text-input').val(''),$('#my_tasks-files').hide(),$('#my_tasks-list').show(),$('#page-header-list').addClass('page-header-submenu-active'),$('#page-header-files').removeClass('page-header-submenu-active'),$('.right-panel-edit').show(),$('.right-panel').hide(),$('.left-panel').removeClass('col-md-12').addClass('col-md-6'),$('#edit-task-implementer').text(b.success.implementer_name).val(b.success.implementer_id),$('.edit-task-other-users').detach();for(var c=0;c<b.success.users.length;c++)b.success.users[c].id!==b.success.implementer_id&&$('#edit-task-delegated-input').append('<option class="edit-task-other-users" value="'+b.success.users[c].id+'">'+b.success.users[c].name+'</option>');switch($('#add-comment-recipient_id').val(b.success.implementer_id),$('.edit-add-task-to-project span').text(b.success.task.project),$('#edit-task-id-input').val(b.success.task.id),$('#edit-task-add-comment').val(b.success.task.id),$('#edit-task-delete-button').attr('data-id',b.success.task.id),$('#edit-task-attach-task_id').val(b.success.task.id),$('#edit-task-project-input').val(b.success.task.project_id),$('#edit-task-status-input').val(b.success.task.status),b.success.task.status){case 0:case 1:case 2:$('#edit-project-status').addClass('edit-project-status').removeClass('edit-project-status-active');break;case 3:$('#edit-project-status').removeClass('edit-project-status').addClass('edit-project-status-active');}if($('#edit-task-title-input').val(b.success.task.title),$('#edit-task-text-input').val(b.success.task.text),$('#text-preview').empty().html(findLinks(b.success.task.text)),$('#edit-uploaded-files tbody').empty(),0!=b.success.files.length){$('.edit-tasks-files').html('<h4>\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u043B\u0435\u043D\u043D\u044B\u0435 \u0444\u0430\u0439\u043B\u044B</h4>');for(var c=0;c<b.success.files.length;c++){let d='';('jpeg'===b.success.files[c].type||'jpg'===b.success.files[c].type||'png'===b.success.files[c].type||'gif'===b.success.files[c].type)&&(d='<br/><img src="/download/'+b.success.files[c].id+'" style="width: 100%; margin-top: 10px;" class="img-small-preview" data-url="/download/'+b.success.files[c].id+'">'),$('#edit-uploaded-files tbody').append('<tr id="small-file-item-'+b.success.files[c].id+'">  <td class="file-link">    <a href="/download/'+b.success.files[c].id+'">      <img class="fileicon" src="/img/fileicons/'+b.success.files[c].type+'.png"> '+b.success.files[c].original_filename+'    </a>    <span class="file-delete" data-id="'+b.success.files[c].id+'">\n      <i class="fa fa-trash" aria-hidden="true"></i>\n    </span>'+d+'  </td></tr>')}}if($('.edit-tasks-comments').empty(),0!=b.success.comments.length)for(var c=0;c<b.success.comments.length;c++){let d='',f='';b.success.comments[c].author_id===$('#current-user').val()&&(f='<span class="comment-edit-button" data-id="'+b.success.comments[c].id+'"><i class="fa fa-pencil" aria-hidden="true"></i></span><span class="comment-delete-button" data-id="'+b.success.comments[c].id+'"><i class="fa fa-trash" aria-hidden="true"></i></span>'),d=b.success.comments[c].author_id?'<a href="/listTasks/'+b.success.comments[c].author_id+'">'+b.success.comments[c].author+'</a>':b.success.comments[c].author,$('.edit-tasks-comments').append('<div class="comment-item '+b.success.comments[c].class+'" id="comment-item-'+b.success.comments[c].id+'">'+b.success.comments[c].date+' <b class="author-string">'+d+': </b><span class="comment-text" id="comment-text-'+b.success.comments[c].id+'">'+b.success.comments[c].text+'</span> '+f+'</div>')}if(autosize($('textarea')),!0===b.success.is_follower?($('.follow-button-block').addClass('follow-button-block-active').attr('data-task_id',b.success.task.id),$('.follow-button-text').text(' \u041E\u0442\u043F\u0438\u0441\u0430\u0442\u044C\u0441\u044F')):($('.follow-button-block').removeClass('follow-button-block-active').attr('data-task_id',b.success.task.id),$('.follow-button-text').text(' \u041F\u043E\u0434\u043F\u0438\u0441\u0430\u0442\u044C\u0441\u044F')),$('.followers-list').empty(),$('.toggle-follower').removeClass('fa-minus-square-o').addClass('fa-plus-square-o'),0<b.success.followers.length)for(var c=0;c<b.success.followers.length;c++)$('.followers-list').append('<a href="/list/'+b.success.followers[c].id+'/0/0" class="users-item" title="'+b.success.followers[c].name+'"id="followers-item-'+b.success.followers[c].id+'"\nstyle="background: '+b.success.followers[c].color+'; margin-left: 0; margin-right: 0;">\n'+b.success.followers[c].first_letters+'</a>'),$('#follower-list-item-'+b.success.followers[c].id+' .toggle-follower').addClass('fa-minus-square-o').removeClass('fa-plus-square-o')}})}function toggleArhiveCommentAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/toggleArhiveCommentAjax/',dataType:'json',data:{comment_id:a},success:function(b){$('.loading').hide(),1===b.success.is_arhive?($('#move-to-arhive-'+a).hide(),$('#move-to-active-'+a).show(),$('.comments-arhive-body').prepend($('#comment-item-'+a).detach())):($('#move-to-active-'+a).hide(),$('#move-to-arhive-'+a).show(),$('.comments-active-body').prepend($('#comment-item-'+a).detach()))}})}function allToArhiveAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/allToArhiveAjax/',dataType:'json',data:{comments_ids:a},success:function(){$('.loading').hide(),$('.comments-active-body .comment-item').each(function(){let c=$(this).attr('data-id');$('#move-to-arhive-'+c).hide(),$('#move-to-active-'+c).show(),$('.comments-arhive-body').prepend($('#comment-item-'+c).detach())})}})}function toggleStatusAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/toggleStatusAjax/',dataType:'json',data:{task_id:a},success:function(b){$('.loading').hide(),$('#complete-button-'+a).removeClass('complete-status-0').removeClass('complete-status-1').removeClass('complete-status-2').removeClass('complete-status-3').addClass('complete-status-'+b.success),$('#task-item-'+a).removeClass('task-visibly-status-0').removeClass('task-visibly-status-1').removeClass('task-visibly-status-2').removeClass('task-visibly-status-3').addClass('task-visibly-status-'+b.success),1===b.success&&2==visibly_filter&&$('#task-item-'+a).hide(800),3===b.success&&1==visibly_filter&&$('#task-item-'+a).hide(800)}})}function asigneeAjax(a,b){$('.loading').show(),ajaxSetup(),$.ajax({url:'/asigneeAjax/',dataType:'json',data:{task_id:a,user_id:b},success:function(c){$('.loading').hide(),$('#asignee-dialog-'+a).hide(),$('#asignee-button-'+a).text(c.success.first_letters)}})}function createProjectAjax(a,b,c){$('.loading').show(),ajaxSetup(),$.ajax({url:'/createProjectAjax/',dataType:'json',data:{title:a,text:b,owner_id:$('#owner_id').val(),status:1,alias:c},success:function(d){let f='';d.success.text&&(f=d.success.text),$('.loading').hide(),$('#new-project-dialog').hide(),$('#new-project-title').val(''),$('#new-project-text').val(''),$('.projects-body').append('<li><a href="/list/0/'+d.success.id+'/1">'+d.success.title+'</a></li>'),$('.projects-panel').prepend('<div class="panel panel-default" id="project-item-'+d.success.id+'">\n                        <div class="panel-heading">\n                            <h3>\n                                <a href="/list/0/'+d.success.id+'/1" id="project-title-'+d.success.id+'">\n                                    '+d.success.title+'\n                                </a>\n                                <div class="float-right edit-project" data-id="'+d.success.id+'">\n                                    <i class="fa fa-pencil" aria-hidden="true"></i>\n                                </div>\n                            </h3>\n                        </div>\n                        <div class="panel-body">\n                            <p id="project-text-'+d.success.id+'">'+f+'</p>\n                            <h4>\u0417\u0430\u0434\u0430\u0447 \u0432 \u043F\u0440\u043E\u0435\u043A\u0442\u0435</h4>\n                            <table class="table text-center">\n                                <tr>\n                                    <th>\u0412\u0441\u0435\u0433\u043E</th>\n                                    <th>\u0412\u044B\u043F\u043E\u043B\u043D\u0435\u043D\u043D\u043E</th>\n                                    <th>\u0412 \u0440\u0430\u0431\u043E\u0442\u0435</th>\n                                </tr>\n                                <tr>\n                                    <td>0</td>\n                                    <td>0</td>\n                                    <td>0</td>\n                                </tr>\n                            </table>\n                            <div class="progress">\n                                <div class="progress-bar" role="progressbar" style="width: 0%"\n                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">\n                                    0%\n                                </div>\n                            </div>\n                        </div>\n                    </div>')}})}function deleteTaskAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/deleteTaskAjax/',dataType:'json',data:{task_id:a},success:function(){$('.loading').hide(),$('.left-panel').addClass('col-md-12').removeClass('col-md-6'),$('.right-panel-edit').hide(),$('#task-item-'+a).detach()}})}function deleteProjectAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/deleteProjectAjax/',dataType:'json',data:{project_id:a},success:function(){$('.loading').hide(),$('.projects-panel').show(),$('.edit-project-panel').hide(),$('#project-item-'+a).detach(),$('#left-menu-project-'+a).detach()}})}function restoreProjectAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/restoreProjectAjax/',dataType:'json',data:{project_id:a},success:function(){$('.loading').hide(),$('#project-item-'+a).detach(),$('#left-menu-project-'+a).detach()}})}function restoreTaskAjax(a){$('.loading').show(),ajaxSetup(),$.ajax({url:'/restoreTaskAjax/',dataType:'json',data:{task_id:a},success:function(){$('.loading').hide(),$('#task-item-'+a).detach()}})}function changeTimeMarkAjax(a,b){$('.loading').show(),ajaxSetup(),$.ajax({url:'/changeTimeMarkAjax/',dataType:'json',data:{task_id:a,time_mark:b},success:function(c){$('.loading').hide(),$('#mark-dialog-'+a).hide(300),$('#task-item-'+a).removeClass('time-mark-new').removeClass('time-mark-today').removeClass('time-mark-later').removeClass('time-mark-upcoming').addClass('time-mark-'+c.success),$('.'+b+'-tasks-body').append($('#task-item-'+a).detach())}})}function updateUserAjax(a,b){$('.loading').show(),ajaxSetup(),$.ajax({url:'/updateUserAjax/',dataType:'json',data:{user_id:a,user_role:b},success:function(){$('.loading').hide()}})}function updateProjectAjax(a,b,c,d){$('.loading').show(),ajaxSetup(),$.ajax({url:'/updateProjectAjax/',dataType:'json',data:{project_id:a,project_title:b,project_text:c,project_alias:d},success:function(f){$('.loading').hide(),$('.projects-panel').show(300),$('.edit-project-panel').hide(300),$('#edit-project-dialog').hide(300),$('#project-title-'+a).text(f.success.title),$('#left-menu-project-'+a).text(f.success.title),$('#project-text-'+a).text(f.success.text)}})}function updateCommentAjax(a,b){$('.loading').show(),ajaxSetup(),$.ajax({url:'/updateCommentAjax/',dataType:'json',data:{comment_id:a,comment_text:b},success:function(c){$('.loading').hide(),$('#edit-comment-dialog').hide(),$('#comment-text-'+a).text(c.success.text)}})}function sendCommentAjax(){let a=$('#create-comment-form').serialize();$('.loading').show(),ajaxSetup(),$.ajax({url:'/sendCommentAjax/',dataType:'json',data:a,success:function(b){console.log(b.success),$('.loading').hide()}})}function updateTaskAjax(){let a=$('#task-edit-form').serialize();$('.loading').show(),ajaxSetup(),$.ajax({url:'/updateTaskAjax/',dataType:'json',data:a,success:function(b){if($('.loading').hide(),1==task_in_progress){let c=' ';0===$('#filter-type').val()&&(c=$('#time-mark-pattern').html()),$('.project-all-tasks-body').prepend('<div class="task-item task-visibly-status-'+b.success.status+' '+b.success.mark_class+'" id="task-item-'+b.success.id+'">\n  <span class="drag-button">    <i class="fa fa-ellipsis-v" aria-hidden="true"></i><i class="fa fa-ellipsis-v" aria-hidden="true"></i>  </span>\n  <span class="complete-button complete-status-'+b.success.status+'" data-id="'+b.success.id+'" id="complete-button-'+b.success.id+'">\n    <i class="fa fa-check-circle-o" aria-hidden="true"></i>\n  </span>\n  <span class="task-title">\n    <a href="/showTask/'+b.success.id+'" class="task-link" data-id="'+b.success.id+'" id="task-link-'+b.success.id+'">\n      '+b.success.title+'\n    </a>\n  </span>\n  <span class="float-right green" id="task-created-label-'+b.success.id+'">\u0417\u0430\u0434\u0430\u0447\u0430 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0441\u043E\u0437\u0434\u0430\u043D\u0430!</span></div>'),$('.new-tasks-body').prepend('<div class="task-item task-visibly-status-'+b.success.status+' '+b.success.mark_class+'" id="task-item-'+b.success.id+'">\n  <span class="drag-button"><i class="fa fa-ellipsis-v" aria-hidden="true"></i><i class="fa fa-ellipsis-v" aria-hidden="true"></i></span>\n  <span class="complete-button complete-status-'+b.success.status+'" data-id="'+b.success.id+'" id="complete-button-'+b.success.id+'">\n    <i class="fa fa-check-circle-o" aria-hidden="true"></i>\n  </span>\n  <span class="task-title">\n    <a href="/showTask/'+b.success.id+'" class="task-link" data-id="'+b.success.id+'" id="task-link-'+b.success.id+'">\n      '+b.success.title+'\n    </a>\n  </span>\n  <span class="float-right green" id="task-created-label-'+b.success.id+'">\u0417\u0430\u0434\u0430\u0447\u0430 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0441\u043E\u0437\u0434\u0430\u043D\u0430!</span>'+c+'</div>'),setTimeout(function(){$('#task-created-label-'+b.success.id).hide(800)},2500),task_in_progress=0}$('#task-link-'+b.success.id).text(b.success.title),$('#task-item-'+b.success.id+' .project-title').detach(),$('#comment-task-item-'+b.success.id+' .project-title').detach(),b.success.project&&0===$('#filter-type').val()&&($('#task-item-'+b.success.id).append('<div class="float-right project-title">\n  <a href="/list/0/'+b.success.project_id+'/1" style="background-color: '+b.success.project_color+'">\n'+b.success.project+'  </a>\n</div>'),$('#comment-task-item-'+b.success.id).append('<div class="project-title">\n  <a href="/list/0/'+b.success.project_id+'/1" style="background-color: '+b.success.project_color+'">\n'+b.success.project+'  </a>\n</div>')),3===b.success.status?$('#complete-button-'+b.success.id).removeClass('complete-status-1').addClass('complete-status-3'):$('#complete-button-'+b.success.id).removeClass('complete-status-3').addClass('complete-status-1'),titleToEmptyLinks(),0===$('#filter-type').val()&&$('#user-id').val()!==b.success.delegated_id&&$('#task-item-'+b.success.id).detach()}})}function toggleSubscribeAjax(){$('.loading').show(),ajaxSetup(),$.ajax({url:'/toggleSubscribeAjax/',dataType:'json',success:function(){$('.loading').hide()}})}function createEmptyTaskAjax(a,b){$('.loading').show(),ajaxSetup(),a||(a=0),$.ajax({url:'/createEmptyTaskAjax/',dataType:'json',data:{project_id:a,implementer_id:b},success:function(c){$('.loading').hide(),task_in_progress=1,getTaskAjax(c.success.id)}})}function ajaxSetup(){$.ajaxSetup({headers:{'X-CSRF-TOKEN':$('meta[name="csrf-token"]').attr('content')}})}